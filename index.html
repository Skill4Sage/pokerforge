<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PokerForge - GTO Coaching</title>
    <!-- Tailwind CSS per un design moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .action-btn { transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-btn:active { transform: scale(0.95); }
        @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 5px rgba(245, 158, 11, 0.4)); } 50% { filter: drop-shadow(0 0 20px rgba(245, 158, 11, 0.8)); } }
        .logo-glow { animation: pulse-glow 3s infinite ease-in-out; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center select-none overflow-x-hidden">

    <!-- Audio Elements (Preloaded) -->
    <audio id="click-sound" src="https://cdn.freesound.org/previews/368/368887_5121236-lq.mp3" preload="auto"></audio>
    <audio id="correct-sound" src="https://cdn.freesound.org/previews/336/336888_5121236-lq.mp3" preload="auto"></audio>
    <audio id="wrong-sound" src="https://cdn.freesound.org/previews/415/415755_5121236-lq.mp3" preload="auto"></audio>

    <!-- Schermata di Avvio (Landing Page) -->
    <div id="start-screen" class="fixed inset-0 z-[200] bg-gray-900 flex flex-col items-center justify-start p-6 text-center overflow-y-auto hide-scrollbar">
        <div class="mb-6 pt-12 flex flex-col items-center">
            <!-- Logo Personalizzato PokerForge -->
            <div class="logo-glow mb-4">
                <svg viewBox="0 0 100 100" class="w-28 h-28">
                    <!-- Base dell'incudine -->
                    <path d="M20 70 L80 70 L85 85 L15 85 Z" fill="#4B5563"/>
                    <path d="M30 40 L70 40 L75 70 L25 70 Z" fill="#374151"/>
                    <path d="M10 40 L30 40 L30 50 C30 50 15 55 10 40" fill="#374151"/>
                    <!-- Nucleo ardente (fucina) -->
                    <circle cx="50" cy="55" r="7" fill="#F59E0B" class="animate-pulse"/>
                    <!-- Semi del Poker -->
                    <text x="50" y="32" font-size="14" text-anchor="middle" fill="#EF4444" font-weight="bold">‚ô•</text>
                    <text x="32" y="58" font-size="10" text-anchor="middle" fill="#FFFFFF" font-weight="bold">‚ô†</text>
                    <text x="68" y="58" font-size="10" text-anchor="middle" fill="#FFFFFF" font-weight="bold">‚ô£</text>
                    <text x="50" y="81" font-size="10" text-anchor="middle" fill="#EF4444" font-weight="bold">‚ô¶</text>
                </svg>
            </div>
            <h1 class="text-5xl font-black text-white mb-2 italic tracking-tighter uppercase">PokerForge</h1>
            <p class="text-orange-400 font-bold tracking-widest text-[10px] uppercase mb-4">Forgia la tua strategia GTO</p>
            <p class="text-gray-400 max-w-xs mx-auto text-sm leading-relaxed">Il simulatore professionale per dominare i range pre-flop e monitorare la tua evoluzione.</p>
        </div>
        
        <!-- Sezione Allenamenti -->
        <h3 class="text-[10px] font-black text-gray-500 uppercase tracking-[0.3em] mb-4">Sessioni di Addestramento</h3>
        <div class="grid grid-cols-1 gap-3 w-full max-w-xs mb-8">
            <button onclick="playSound('click-sound'); startApp(30, 1.0, 'random')" class="py-4 bg-gray-800 border-2 border-green-500 text-white rounded-2xl font-bold flex justify-between px-6 items-center hover:bg-green-500 transition-all group">
                <span class="italic uppercase">Standard (30)</span>
                <span class="text-[10px] bg-green-500 group-hover:bg-white group-hover:text-green-600 px-2 py-0.5 rounded font-black">x1.0 XP</span>
            </button>
            <button onclick="playSound('click-sound'); startApp(50, 1.2, 'random')" class="py-4 bg-gray-800 border-2 border-blue-500 text-white rounded-2xl font-bold flex justify-between px-6 items-center hover:bg-blue-500 transition-all group">
                <span class="italic uppercase">Pro (50)</span>
                <span class="text-[10px] bg-blue-500 group-hover:bg-white group-hover:text-blue-600 px-2 py-0.5 rounded font-black">x1.2 XP</span>
            </button>
            
            <button id="weak-spot-btn" onclick="playSound('click-sound'); startApp(30, 1.5, 'weak-spot')" class="mt-2 py-4 bg-gradient-to-br from-orange-600 to-red-700 text-white rounded-2xl font-black flex justify-between px-6 items-center shadow-lg shadow-red-900/40 group relative overflow-hidden">
                <div class="flex flex-col items-start z-10">
                    <span class="text-sm italic uppercase">Focus Debolezze</span>
                    <span class="text-[9px] opacity-80 font-medium">Recupero errori storici</span>
                </div>
                <span class="text-[10px] bg-white text-red-700 px-2 py-0.5 rounded font-black z-10">x1.5 XP</span>
                <div class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            </button>
        </div>

        <button onclick="playSound('click-sound'); toggleHistory(true)" class="mb-10 flex items-center text-blue-400 font-black text-[10px] uppercase tracking-[0.2em] hover:text-blue-300 transition-colors">
            <span class="mr-2 text-base">üìä</span> Progressi & Storico
        </button>

        <div class="flex space-x-12 text-gray-500 text-[10px] uppercase tracking-[0.2em] font-black pb-10">
            <div class="flex flex-col"><span class="text-white text-xl font-mono" id="start-xp">0</span><span>XP Totali</span></div>
            <div class="flex flex-col"><span class="text-white text-xl font-mono" id="start-streak">0</span><span>Best Streak</span></div>
        </div>
    </div>

    <!-- Schermata Storico -->
    <div id="history-screen" class="fixed inset-0 z-[400] bg-gray-50 hidden flex-col p-6 overflow-y-auto">
        <div class="max-w-md mx-auto w-full pb-10">
            <div class="flex justify-between items-center mb-8">
                <div class="flex flex-col">
                    <h2 class="text-3xl font-black text-gray-900 tracking-tighter italic uppercase">PokerForge</h2>
                    <span class="text-[10px] font-black text-blue-500 uppercase tracking-widest">Analytics Dashboard</span>
                </div>
                <button onclick="playSound('click-sound'); toggleHistory(false)" class="p-2 bg-gray-200 rounded-full w-10 h-10 flex items-center justify-center font-bold">‚úï</button>
            </div>

            <!-- Trend Card -->
            <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-gray-100 mb-6 relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-5">
                    <svg viewBox="0 0 100 100" class="w-20 h-20"><path d="M10 80 L30 50 L50 60 L90 20" stroke="currentColor" stroke-width="8" fill="none" class="text-blue-600"/></svg>
                </div>
                <h3 class="text-[10px] font-black text-gray-400 uppercase mb-4 tracking-widest">Stato del Miglioramento</h3>
                <div id="trend-analysis" class="flex items-center space-x-4 relative z-10">
                    <!-- Iniettato da JS -->
                </div>
            </div>

            <h3 class="text-[10px] font-black text-gray-400 uppercase mb-4 tracking-widest">Ultime Sessioni</h3>
            <div id="history-list" class="space-y-3">
                <!-- Elenco sessioni -->
            </div>
        </div>
    </div>

    <!-- Riepilogo Finale -->
    <div id="summary-screen" class="fixed inset-0 z-[300] bg-white hidden flex-col p-6 overflow-y-auto">
        <div class="max-w-md mx-auto w-full pb-10">
            <h2 class="text-4xl font-black text-gray-900 mb-2 italic uppercase tracking-tighter">Sessione Conclusa</h2>
            <p id="summary-score" class="text-xl text-blue-600 font-bold mb-8 tracking-tight font-mono">Accuracy: --</p>
            
            <div class="bg-gray-900 rounded-[2.5rem] p-8 mb-8 border border-gray-800 shadow-2xl relative overflow-hidden">
                <div class="absolute -right-6 -top-6 text-7xl opacity-10 rotate-12">‚öíÔ∏è</div>
                <h4 class="font-black text-orange-400 mb-4 flex items-center italic uppercase text-xs tracking-widest">Analisi della Fucina</h4>
                <p id="coach-advice" class="text-sm text-gray-300 leading-relaxed mb-6"></p>
                <div id="critical-hands" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="space-y-4 mb-10">
                <h4 class="font-black text-gray-400 text-[10px] uppercase tracking-[0.3em]">Precisione per Posizione</h4>
                <div id="error-stats" class="grid grid-cols-1 gap-2"></div>
            </div>

            <button onclick="playSound('click-sound'); location.reload()" class="w-full py-5 bg-blue-600 text-white rounded-2xl font-black text-lg shadow-xl uppercase tracking-[0.2em] active:scale-95 transition-transform">
                Torna alla Fucina
            </button>
        </div>
    </div>

    <!-- Interfaccia App (Quiz) -->
    <div id="app-content" class="w-full flex flex-col items-center opacity-0 transition-opacity duration-500 pointer-events-none">
        <div class="w-full max-w-md bg-white border-b-2 border-gray-200 p-4 sticky top-0 z-50 flex justify-between items-center">
            <div class="flex flex-col">
                <span class="text-[10px] text-blue-500 font-black uppercase tracking-widest italic" id="mode-label">PokerForge</span>
                <span class="text-gray-800 font-black text-sm font-mono" id="session-counter">1 / 30</span>
            </div>
            <div class="flex-grow mx-4">
                <div class="h-2.5 w-full bg-gray-100 rounded-full overflow-hidden">
                    <div id="session-progress" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-orange-500 font-bold">üî• <span id="streak" class="font-mono">0</span></span>
            </div>
        </div>

        <div class="w-full max-w-md h-1.5 bg-gray-50">
            <div id="timer-bar" class="h-full bg-orange-400 w-full rounded-r-full"></div>
        </div>

        <main class="w-full max-w-md p-6 flex flex-col items-center space-y-10 flex-grow">
            <div id="position-badge" class="px-8 py-2.5 bg-gray-900 text-white rounded-full text-[11px] font-black uppercase tracking-[0.4em] shadow-lg">
                Posizione: --
            </div>
            
            <div class="text-center">
                <h2 class="text-2xl font-black text-gray-800 leading-tight italic uppercase tracking-tighter">Tutti foldano.</h2>
                <p class="text-blue-500 font-black uppercase text-[10px] tracking-[0.2em] mt-1">Qual √® la mossa GTO?</p>
            </div>
            
            <div class="w-full bg-emerald-900 rounded-[3.5rem] p-12 shadow-2xl flex flex-col items-center relative overflow-hidden border-8 border-emerald-800/50">
                <div class="absolute inset-0 opacity-5 pointer-events-none" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 30px 30px;"></div>
                <div id="cards-container" class="flex space-x-6 relative z-10 scale-[1.35]"></div>
                <div id="equity-badge" class="mt-14 text-emerald-100 text-[10px] font-black opacity-30 uppercase tracking-[0.3em]">--</div>
            </div>

            <div class="grid grid-cols-2 gap-5 w-full">
                <button onclick="handleAction('RAISE')" class="action-btn py-6 bg-white border-b-8 border-green-600 rounded-3xl text-green-600 font-black text-2xl shadow-xl active:scale-95 hover:bg-green-50 uppercase italic tracking-tighter">RAISE</button>
                <button onclick="handleAction('FOLD')" class="action-btn py-6 bg-white border-b-8 border-red-600 rounded-3xl text-red-600 font-black text-2xl shadow-xl active:scale-95 hover:bg-red-50 uppercase italic tracking-tighter">FOLD</button>
            </div>
        </main>
    </div>

    <!-- Feedback Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black/80 hidden items-end justify-center z-[100] p-4 backdrop-blur-lg">
        <div class="bg-white w-full max-w-md rounded-t-[3rem] p-10 transform translate-y-0 transition-transform shadow-2xl">
            <div id="result-icon" class="text-7xl mb-6">‚úÖ</div>
            <h3 id="result-title" class="text-4xl font-black mb-3 italic tracking-tighter uppercase"></h3>
            <p id="result-text" class="text-gray-600 mb-12 leading-relaxed text-sm font-medium"></p>
            <button id="next-btn-text" onclick="playSound('click-sound'); resetRound()" class="w-full py-6 bg-blue-600 text-white rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition-transform uppercase tracking-widest italic">Continua</button>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE RANGES GTO
        const GTO_RANGES = {
            'UTG': { perc: 15, pairs: ['AA','KK','QQ','JJ','1010','99','88','77'], suitedAces: ['AK','AQ','AJ','A10'], offsuitAces: ['AK','AQ'], suitedBroad: ['KQ','KJ','QJ'], suitedConn: ['J10','109'] },
            'MP': { perc: 18, pairs: ['AA','KK','QQ','JJ','1010','99','88','77','66'], suitedAces: ['AK','AQ','AJ','A10','A9','A8'], offsuitAces: ['AK','AQ','AJ'], suitedBroad: ['KQ','KJ','QJ','KT','QT','JT'], suitedConn: ['J10','109','98'] },
            'CO': { perc: 26, pairs: ['AA','KK','QQ','JJ','1010','99','88','77','66','55','44'], suitedAces: ['AK','AQ','AJ','A10','A9','A8','A7','A6','A5','A4','A3','A2'], offsuitAces: ['AK','AQ','AJ','A10'], suitedBroad: ['KQ','KJ','QJ','KT','QT','JT','K9','Q9','J9','T9'], suitedConn: ['J10','109','98','87','76'] },
            'BTN': { perc: 48, pairs: ['AA','KK','QQ','JJ','1010','99','88','77','66','55','44','33','22'], suitedAces: ['AK','AQ','AJ','A10','A9','A8','A7','A6','A5','A4','A3','A2'], offsuitAces: ['AK','AQ','AJ','A10','A9','A8','A7'], suitedBroad: ['KQ','KJ','QJ','KT','QT','JT','K9','Q9','J9','T9','K8','K7','K6','K5','K4','K3','K2'], suitedConn: ['J10','109','98','87','76','65','54','J8','T8','97'] },
            'SB': { perc: 42, pairs: ['AA','KK','QQ','JJ','1010','99','88','77','66','55','44','33','22'], suitedAces: ['AK','AQ','AJ','A10','A9','A8','A7','A6','A5','A4','A3','A2'], offsuitAces: ['AK','AQ','AJ','A10','A9','A8'], suitedBroad: ['KQ','KJ','QJ','KT','QT','JT','K9','Q9','J9','T9','K8','K7'], suitedConn: ['J10','109','98','87','76','65','54'] }
        };

        const CARD_VALUES = ['A','K','Q','J','10','9','8','7','6','5','4','3','2'];
        const POSITIONS = ['UTG', 'MP', 'CO', 'BTN', 'SB'];

        let state = {
            totalXP: parseInt(localStorage.getItem('poker_xp')) || 0,
            bestStreak: parseInt(localStorage.getItem('poker_best_streak')) || 0,
            sessionHistory: JSON.parse(localStorage.getItem('poker_history')) || [],
            
            sessionTotal: 0,
            sessionCurrent: 0,
            sessionCorrect: 0,
            sessionXPBonus: 1.0,
            sessionMode: 'random',
            sessionErrors: [],
            
            currentStreak: 0,
            currentHand: null,
            timer: null,
            timeLeft: 100
        };

        function playSound(id) {
            const sound = document.getElementById(id);
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.error("Errore riproduzione audio:", e));
            }
        }

        function toggleHistory(show) {
            const screen = document.getElementById('history-screen');
            if(show) {
                renderHistory();
                screen.classList.remove('hidden');
                screen.classList.add('flex');
            } else {
                screen.classList.add('hidden');
                screen.classList.remove('flex');
            }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const trendContainer = document.getElementById('trend-analysis');
            list.innerHTML = '';
            
            if(state.sessionHistory.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center py-12 italic text-sm">Nessuna sessione forgiata ancora.</p>';
                trendContainer.innerHTML = '<p class="text-gray-500 italic text-sm">Completa 5 sessioni per l\'analisi del trend.</p>';
                document.getElementById('weak-spot-btn').style.opacity = '0.5';
                document.getElementById('weak-spot-btn').onclick = null;
                return;
            } else {
                document.getElementById('weak-spot-btn').style.opacity = '1';
                document.getElementById('weak-spot-btn').onclick = () => { playSound('click-sound'); startApp(30, 1.5, 'weak-spot'); };
            }

            const recent = state.sessionHistory.slice(-5);
            const older = state.sessionHistory.slice(-10, -5);
            const recentAcc = recent.reduce((sum, s) => sum + s.acc, 0) / recent.length;
            const olderAcc = older.length > 0 ? older.reduce((sum, s) => sum + s.acc, 0) / older.length : 0;

            if(older.length > 0) {
                const diff = recentAcc - olderAcc;
                const icon = diff >= 0 ? 'üìà' : 'üìâ';
                const color = diff >= 0 ? 'text-green-600' : 'text-red-600';
                trendContainer.innerHTML = `<div class="text-4xl">${icon}</div><div><p class="${color} font-black text-xl italic font-mono">${diff >= 0 ? '+' : ''}${Math.round(diff)}% Accuracy</p><p class="text-gray-400 text-[9px] uppercase font-black tracking-widest">Rispetto al periodo precedente</p></div>`;
            } else {
                trendContainer.innerHTML = '<p class="text-blue-600 font-black text-sm italic">Forgiando i dati... completa pi√π sessioni.</p>';
            }

            state.sessionHistory.slice().reverse().forEach(s => {
                const date = new Date(s.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                list.innerHTML += `<div class="bg-white p-6 rounded-[2rem] flex justify-between items-center shadow-sm border border-gray-100"><div class="text-left"><p class="text-[9px] font-black text-gray-300 uppercase tracking-widest mb-1 font-mono">${date}</p><p class="font-black text-gray-800 italic uppercase text-sm">${s.hands} Mani</p></div><div class="text-right"><p class="text-blue-600 font-black text-2xl italic font-mono leading-none">${s.acc}%</p><p class="text-[8px] text-gray-400 uppercase font-black tracking-[0.2em] mt-1">${s.score} WIN</p></div></div>`;
            });
        }

        function startApp(numHands, bonus, mode) {
            state.sessionTotal = numHands;
            state.sessionXPBonus = bonus;
            state.sessionMode = mode;
            state.sessionCurrent = 0;
            state.sessionCorrect = 0;
            state.sessionErrors = [];
            state.currentStreak = 0;

            document.getElementById('mode-label').innerText = mode === 'weak-spot' ? 'üî• FOCUS DEBOLEZZE' : 'PokerForge';
            document.getElementById('start-screen').classList.add('opacity-0');
            setTimeout(() => {
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('opacity-0', 'pointer-events-none');
                resetRound();
            }, 500);
        }

        function getEquity(v1, v2, suited) {
            if(v1 === v2) return (80 - CARD_VALUES.indexOf(v1) * 2) + "%";
            let base = 50 - (CARD_VALUES.indexOf(v1) + CARD_VALUES.indexOf(v2));
            if(suited) base += 4;
            return Math.max(15, Math.min(68, base)) + "%";
        }

        function generateHand() {
            let pos, category;
            if (state.sessionMode === 'weak-spot' && state.sessionHistory.length > 0 && Math.random() < 0.8) {
                const allErrors = state.sessionHistory.flatMap(s => s.errors || []);
                if (allErrors.length > 0) {
                    const randomError = allErrors[Math.floor(Math.random() * allErrors.length)];
                    pos = randomError.pos;
                    category = randomError.category;
                }
            }
            if (!pos) pos = POSITIONS[Math.floor(Math.random() * POSITIONS.length)];
            const isPair = category ? category === "Coppie" : Math.random() < 0.06;
            const isSuited = category ? category === "Suited" : (!isPair && Math.random() < 0.24);
            let v1, v2;
            if (isPair) v1 = v2 = CARD_VALUES[Math.floor(Math.random() * CARD_VALUES.length)];
            else {
                v1 = CARD_VALUES[Math.floor(Math.random() * (CARD_VALUES.length - 1))];
                v2 = CARD_VALUES[Math.floor(Math.random() * (CARD_VALUES.indexOf(v1) + 1) + (CARD_VALUES.indexOf(v1) + 1))];
                if (!v2) v2 = CARD_VALUES[CARD_VALUES.length - 1];
            }
            const handStr = v1 + v2;
            const range = GTO_RANGES[pos];
            let shouldRaise = false;
            let finalCategory = "Broadways";
            if (isPair) { finalCategory = "Coppie"; if (range.pairs.includes(handStr)) shouldRaise = true; }
            else if (isSuited) {
                finalCategory = "Suited";
                if (v1 === 'A' && range.suitedAces.includes(handStr)) shouldRaise = true;
                else if (range.suitedBroad && range.suitedBroad.includes(handStr)) shouldRaise = true;
                else if (range.suitedConn && range.suitedConn.includes(handStr)) shouldRaise = true;
            } else {
                finalCategory = "Offsuit";
                if (v1 === 'A' && range.offsuitAces.includes(handStr)) shouldRaise = true;
                else if (range.offsuitBroad && range.offsuitBroad.includes(handStr)) shouldRaise = true;
            }
            return { pos, v1, v2, isSuited, isPair, category: finalCategory, correctAction: shouldRaise ? 'RAISE' : 'FOLD', equity: getEquity(v1, v2, isSuited) };
        }

        function renderCards() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
            const suit1 = suits[Math.floor(Math.random()*4)];
            const suit2 = state.currentHand.isSuited ? suit1 : suits[(suits.indexOf(suit1)+1)%4];
            [ {v: state.currentHand.v1, s: suit1}, {v: state.currentHand.v1 === state.currentHand.v2 ? state.currentHand.v1 : state.currentHand.v2, s: suit2} ].forEach(c => {
                const color = (c.s === '‚ô•' || c.s === '‚ô¶') ? 'text-red-600' : 'text-gray-900';
                container.innerHTML += `<div class="w-20 h-32 bg-white rounded-2xl shadow-2xl flex flex-col items-center justify-between p-3 border border-gray-100"><div class="self-start text-xl font-black ${color}">${c.v}</div><div class="text-4xl ${color}">${c.s}</div><div class="self-end text-xl font-black rotate-180 ${color}">${c.v}</div></div>`;
            });
        }

        function startTimer() {
            state.timeLeft = 100;
            const bar = document.getElementById('timer-bar');
            clearInterval(state.timer);
            state.timer = setInterval(() => {
                state.timeLeft -= 2.5;
                bar.style.width = state.timeLeft + '%';
                if(state.timeLeft <= 0) { clearInterval(state.timer); handleAction('TIMEOUT'); }
            }, 100);
        }

        function handleAction(choice) {
            clearInterval(state.timer);
            const hand = state.currentHand;
            const isCorrect = choice === hand.correctAction;
            const handName = `${hand.v1}${hand.v2}${hand.isSuited ? 's' : (hand.isPair ? '' : 'o')}`;
            state.sessionCurrent++;
            
            if (isCorrect) {
                playSound('correct-sound'); // Suono Corretto
                state.sessionCorrect++; state.currentStreak++;
                if(state.currentStreak > state.bestStreak) state.bestStreak = state.currentStreak;
                document.getElementById('result-icon').innerText = "‚úÖ";
                document.getElementById('result-title').innerText = "CORRETTO";
                document.getElementById('result-text').innerHTML = `Da <b>${hand.pos}</b> apriamo circa il ${GTO_RANGES[hand.pos].perc}%. Ottima lettura della mano <b>${handName}</b>.`;
            } else {
                playSound('wrong-sound'); // Suono Sbagliato o Timeout
                state.sessionErrors.push({ pos: hand.pos, hand: handName, category: hand.category });
                state.currentStreak = 0;
                document.getElementById('result-icon').innerText = "‚ùå";
                document.getElementById('result-title').innerText = "ERRORE";
                document.getElementById('result-text').innerHTML = `La mossa corretta da <b>${hand.pos}</b> era <b>${hand.correctAction}</b>. Questa mano (${handName}) √® ${hand.correctAction === 'RAISE' ? 'nel' : 'fuori dal'} range.`;
            }
            if(state.sessionCurrent >= state.sessionTotal) document.getElementById('next-btn-text').innerText = "VEDI ANALISI";
            else document.getElementById('next-btn-text').innerText = "PROSSIMA MANO";
            saveProgress();
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('overlay').classList.add('flex');
        }

        function saveProgress() {
            localStorage.setItem('poker_xp', state.totalXP);
            localStorage.setItem('poker_best_streak', state.bestStreak);
            document.getElementById('streak').innerText = state.currentStreak;
            document.getElementById('session-counter').innerText = `${state.sessionCurrent} / ${state.sessionTotal}`;
            document.getElementById('session-progress').style.width = (state.sessionCurrent / state.sessionTotal * 100) + '%';
        }

        function resetRound() {
            if(state.sessionCurrent >= state.sessionTotal) { showFinalSummary(); return; }
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('overlay').classList.remove('flex');
            state.currentHand = generateHand();
            document.getElementById('position-badge').innerText = `Posizione: ${state.currentHand.pos}`;
            document.getElementById('equity-badge').innerText = `Equity stimata: ${state.currentHand.equity}`;
            renderCards(); startTimer();
        }

        function showFinalSummary() {
            const acc = Math.round(state.sessionCorrect/state.sessionTotal*100);
            const xpGained = Math.round(state.sessionCorrect * 25 * state.sessionXPBonus);
            state.totalXP += xpGained;
            const sessionData = { date: new Date().toISOString(), hands: state.sessionTotal, score: state.sessionCorrect, acc: acc, errors: state.sessionErrors };
            state.sessionHistory.push(sessionData);
            if(state.sessionHistory.length > 50) state.sessionHistory.shift();
            localStorage.setItem('poker_history', JSON.stringify(state.sessionHistory));
            localStorage.setItem('poker_xp', state.totalXP);
            document.getElementById('summary-screen').classList.remove('hidden');
            document.getElementById('summary-screen').classList.add('flex');
            document.getElementById('summary-score').innerText = `Accuracy: ${acc}% (${state.sessionCorrect}/${state.sessionTotal})`;
            const handCount = {}; const catCount = {}; const posCount = {};
            state.sessionErrors.forEach(err => {
                handCount[err.hand] = (handCount[err.hand] || 0) + 1;
                catCount[err.category] = (catCount[err.category] || 0) + 1;
                posCount[err.pos] = (posCount[err.pos] || 0) + 1;
            });
            const topHands = Object.keys(handCount).sort((a,b) => handCount[b] - handCount[a]).slice(0, 3);
            const critContainer = document.getElementById('critical-hands');
            critContainer.innerHTML = '';
            topHands.forEach(h => { critContainer.innerHTML += `<span class="bg-orange-600/20 text-orange-400 px-3 py-1 rounded-full text-xs font-black italic border border-orange-600/30">${h}</span>`; });
            const statContainer = document.getElementById('error-stats');
            statContainer.innerHTML = '';
            POSITIONS.forEach(p => {
                const errors = posCount[p] || 0;
                statContainer.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-4 rounded-3xl border border-gray-100 shadow-sm"><span class="font-black text-gray-800 italic uppercase text-xs font-mono">${p}</span><span class="${errors > 0 ? 'text-red-500' : 'text-green-600'} font-black text-[9px] tracking-[0.2em] font-mono">${errors === 0 ? 'DOMINATO' : errors + ' ERRORI'}</span></div>`;
            });
            const worstCat = Object.keys(catCount).reduce((a, b) => catCount[a] > catCount[b] ? a : b, null);
            let advice = worstCat ? `La fucina suggerisce di lavorare sulle <b>${worstCat}</b>.` : "Precisione chirurgica. Sessione forgiata nel metallo!";
            document.getElementById('coach-advice').innerHTML = advice + (topHands.length ? `<br><span class='text-xs opacity-70'>Mani critiche: ${topHands.join(', ')}</span>` : "");
        }

        document.getElementById('start-xp').innerText = state.totalXP;
        document.getElementById('start-streak').innerText = state.bestStreak;
    </script>
</body>
</html>
